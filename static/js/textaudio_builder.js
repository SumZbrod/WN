import {BGMSE_player, BGM_mute} from './BGMSE_module.js'
import {typeEffect} from "./TypingModule.js"
import {Draw_CG, DrawSprite, clearAllSprites} from "./Paiting.js"
import { createAudioPlayerHTML } from './AudioPlayer.js';
import {trimAndSendAudio} from './anki_send.js'

// Texts
const textContainer = document.getElementById('text-container');
let currentBatch = [];
let nextBatch = [];
let currentIndex = 0;
const batchSize = 20; // –†–∞–∑–º–µ—Ä –ø–∞—á–∫–∏
const container = document.getElementById('audio-container');
const Player = createAudioPlayerHTML(container, '/static/test.ogg');
let scriptName;
let globalIndex = 0;
console.log('Script Name:', scriptName);


function fetchTextBatch(callback, new_gi=0) {
    // console.log("Fetching new batch of text...");
    // –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç URL —Å —Ç–µ–∫—É—â–∏–º URL
    const url = new URL(window.location.href);
    const params = new URLSearchParams(url.search);

    scriptName = params.get('script_name')
    if (new_gi===0) {
        globalIndex = parseFloat(params.get('global_index'));
    }
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º URLSearchParams –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
    globalIndex += new_gi;
    // –í—ã–≤–æ–¥–∏–º –∑–Ω–∞—á–µ–Ω–∏—è –≤ –∫–æ–Ω—Å–æ–ª—å
    // –í—ã–≤–æ–¥–∏–º –∑–Ω–∞—á–µ–Ω–∏—è –≤ –∫–æ–Ω—Å–æ–ª—å
    console.log('new_gi:', new_gi);
    console.log('Global Index:', globalIndex);

    fetch(`/get_text?script_name=${scriptName}&global_index=${globalIndex}`)
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok' + response.statusText);
        }
        const res = response.json();
        return res;
    })
    .then(batch => {
        callback(batch);
    })
    .catch(error => {
        console.error('There was a problem with the fetch operation:', error);
    });
}

function addNextBlock() {
    console.log('currentIndex', currentIndex);
    if (currentIndex < currentBatch.length) {
        const item = currentBatch[currentIndex];
        console.log('item.block_type', item.block_type)
        if (item.block_type === "speach_line") {
            // console.log('type speach')
            const content = item.content
            
            const textBox = document.createElement('div');
            textBox.classList.add('text-box');
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—É—Ç—å –∫ –∞—É–¥–∏–æ –≤ –±–ª–æ–∫
            if (content.audioPath) {
                const voice_path = content.audioPath;
                textBox.dataset.voicePath = voice_path;
                Player.change_audio(voice_path);
                // –ö–Ω–æ–ø–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
                const playButton = document.createElement('button');
                playButton.classList.add('play-button');
                playButton.textContent = '‚ñ∂Ô∏è';
                playButton.addEventListener('click', (event) => {
                    const voice_path = event.currentTarget.closest('.text-box')?.dataset.voicePath;
                    console.log('voice_path', voice_path);
                    if (!voice_path) return;
                    Player.change_audio(voice_path);
                });
                textBox.appendChild(playButton);
            
                // –ö–Ω–æ–ø–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è Anki –∫–∞—Ä—Ç–æ—á–∫–∏
                const updateButton = document.createElement('button');
                updateButton.classList.add('anki-update-button');
                updateButton.textContent = 'üîÑ'; // –ú–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ –¥—Ä—É–≥—É—é –∏–∫–æ–Ω–∫—É
                updateButton.addEventListener('click', async (event) => {
                    const voice_path = event.currentTarget.closest('.text-box')?.dataset.voicePath;
                    const translate_sentence = event.currentTarget.closest('.text-box')?.querySelector('.translated').textContent;

                    console.log('voice_path', voice_path);
                    if (!voice_path) return;
            
                    try {
                        const audioFilename = `audio_${Date.now()}.mp3`;
                        console.log('audioFilename', audioFilename);
                        
                        trimAndSendAudio(voice_path, Player.starttime, audioFilename);
                        // –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –¥–æ–±–∞–≤–ª–µ–Ω–Ω—É—é –∫–∞—Ä—Ç–æ—á–∫—É
                        const findRes = await fetch("http://127.0.0.1:8765", {
                            method: "POST",
                            body: JSON.stringify({
                                action: "findNotes",
                                version: 6,
                                params: { query: "added:1" }
                            })
                        });
                        const findData = await findRes.json();
                        if (!findData.result.length) {
                            alert("–ö–∞—Ä—Ç–æ—á–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.");
                            return;
                        }
                        const CardsIds = findData.result;
                        const noteId = findData.result[CardsIds.length - 1];
                        console.log('noteId', noteId);
                        console.log('findData.result', findData.result);
                        // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª–µ SentenceAudio
                        await fetch("http://127.0.0.1:8765", {
                            method: "POST",
                            body: JSON.stringify({
                                action: "updateNoteFields",
                                version: 6,
                                params: {
                                    note: {
                                        id: noteId,
                                        fields: {
                                            SentenceAudio: `[sound:${audioFilename}]`,
                                            Comment: `${translate_sentence}`,
                                        }
                                    }
                                }
                            })
                        });
            
                        console.log("–ê—É–¥–∏–æ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ –≤ –∫–∞—Ä—Ç–æ—á–∫–µ Anki.");
                    } catch (err) {
                        console.error("–û—à–∏–±–∫–∞:", err);
                        console.log("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ Anki.");
                    }
                });
                textBox.appendChild(updateButton);
            }
            
            const originalText = document.createElement('p');
            originalText.classList.add('original');
            
            const translatedText = document.createElement('p');
            translatedText.classList.add('translated');
            translatedText.textContent = content.translate;
            
            textBox.appendChild(originalText);
            textBox.appendChild(translatedText);
            textContainer.appendChild(textBox);
            



            textContainer.scrollTo(0, textContainer.scrollHeight+100); // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –Ω–∞—á–∞–ª—É
            typeEffect(originalText, content.orig);
        }
        
        else if (item.block_type === 'bgmse') {
            const bgmse_path = item.content.path;
            const bgmse_channel = item.content.channel;
            const bgmse_audio_type = item.content.audio_type;
            BGMSE_player(bgmse_path, bgmse_channel, bgmse_audio_type);
        }
        else if (item.block_type === 'mute_bgm') {
            const bgm_channel = item.content.channel;
            BGM_mute(bgm_channel);
        }
        else if (item.block_type === 'draw_cg') {
            const cg_path = item.content.path;
            Draw_CG(cg_path);
        }
        else if (item.block_type === 'clear_sprites') {
            clearAllSprites();
        }
        else if (item.block_type === 'draw_sprite') {
            const sprite_path = item.content.path;
            const x_pos = item.content.position_x;
            DrawSprite(sprite_path, x_pos);
        }
        currentIndex++;
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ª–µ–¥—É—é—â—É—é –ø–∞—á–∫—É, –µ—Å–ª–∏ –¥–æ—Å—Ç–∏–≥–ª–∏ 5-–≥–æ –±–ª–æ–∫–∞ —Ç–µ–∫—É—â–µ–π
        if (currentIndex === batchSize / 2) {
            fetchTextBatch((batch) => {
                // console.log('Preload next batch')
                
                nextBatch = batch;
            },batchSize);
        }
        if (item.wait_time >= 0) {
            setTimeout(() => {
                addNextBlock(); // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –±–ª–æ–∫—É –ø–æ—Å–ª–µ –æ–∂–∏–¥–∞–Ω–∏—è
            }, item.wait_time * 1000);
        }
    }
    else {
        currentBatch = nextBatch;
        if (currentBatch.length===0) {
            window.location.assign('/menu');
            return;
        }
        currentIndex = 0;
        nextBatch = [];
        if (currentBatch) {
            addNextBlock(); // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø–µ—Ä–≤—ã–π –±–ª–æ–∫ –∏–∑ –Ω–æ–≤–æ–π –ø–∞—á–∫–∏
        }
    }
}

function setupTextAudio() {
    let first_time = true;
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è –Ω–∞–∂–∞—Ç–∏—è –ø—Ä–æ–±–µ–ª–∞
    
    document.addEventListener('keydown', (event) => {
        if (event.code === 'Space') {
            if (first_time){
                first_time = false;
                console.log("start create audio player");
            }
          

            event.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–æ–±–µ–ª–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–æ–∫—Ä—É—Ç–∫–∞)
            addNextBlock();
            textContainer.scrollTo(0, textContainer.scrollHeight+100); // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –Ω–∞—á–∞–ª—É
        }
        else if (event.code === 'KeyR') {
            Player.repeat();
        }
        else if (event.code === 'KeyS') {
            Player.stop();
        }
    });
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å –ø–µ—Ä–≤–æ–π –ø–∞—á–∫–∏
    fetchTextBatch((batch) => {
        currentBatch = batch;
    });
    
}


export {setupTextAudio};



